import streamlit as st
import pymysql
from pymysql import Error
import hashlib
from datetime import datetime, date
import pandas as pd
import plotly.express as px

# Database Configuration
DB_CONFIG = {
    'host': '127.0.0.1',
    'user': 'root',
    'password': 'root',
    'database': 'movie_booking',
    'charset': 'utf8mb4',
    'cursorclass': pymysql.cursors.DictCursor
}

# Database functions (unchanged)
def get_db_connection():
    try:
        conn = pymysql.connect(**DB_CONFIG)
        return conn
    except Exception as e:
        st.error(f"Database connection error: {e}")
        return None

def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

def register_user(username, password, email):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        try:
            hashed_pw = hash_password(password)
            cursor.execute("INSERT INTO Users (username, password_hash, email) VALUES (%s, %s, %s)", (username, hashed_pw, email))
            conn.commit()
            return True
        except Exception as e:
            st.error(f"Registration failed: {e}")
            return False
        finally:
            cursor.close()
            conn.close()
    return False

def login_user(username, password):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        try:
            hashed_pw = hash_password(password)
            cursor.execute("SELECT * FROM Users WHERE username = %s AND password_hash = %s", (username, hashed_pw))
            return cursor.fetchone()
        finally:
            cursor.close()
            conn.close()
    return None

def get_movies():
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        try:
            cursor.execute("SELECT * FROM Movies ORDER BY release_year DESC, rating DESC")
            return cursor.fetchall()
        finally:
            cursor.close()
            conn.close()
    return []

def get_showtimes(movie_id):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        try:
            cursor.execute("SELECT * FROM Showtimes WHERE movie_id = %s AND available_seats > 0 ORDER BY show_date, show_time", (movie_id,))
            return cursor.fetchall()
        finally:
            cursor.close()
            conn.close()
    return []

def get_booked_seats(showtime_id):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        try:
            cursor.execute("SELECT seat_numbers FROM Bookings WHERE showtime_id = %s", (showtime_id,))
            results = cursor.fetchall()
            booked_seats = []
            for row in results:
                if row['seat_numbers']:
                    booked_seats.extend(row['seat_numbers'].split(','))
            return booked_seats
        finally:
            cursor.close()
            conn.close()
    return []

def book_tickets(user_id, showtime_id, selected_seats):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        try:
            num_tickets = len(selected_seats)
            seat_numbers = ','.join(selected_seats)
            cursor.execute("SELECT available_seats FROM Showtimes WHERE showtime_id = %s", (showtime_id,))
            result = cursor.fetchone()
            if result and result['available_seats'] >= num_tickets:
                cursor.execute("INSERT INTO Bookings (user_id, showtime_id, tickets_booked, booking_date, seat_numbers) VALUES (%s, %s, %s, %s, %s)",
                              (user_id, showtime_id, num_tickets, datetime.now(), seat_numbers))
                cursor.execute("UPDATE Showtimes SET available_seats = available_seats - %s WHERE showtime_id = %s", (num_tickets, showtime_id))
                conn.commit()
                return True
            else:
                st.error("Not enough seats available!")
                return False
        except Exception as e:
            st.error(f"Booking failed: {e}")
            return False
        finally:
            cursor.close()
            conn.close()
    return False

def get_user_bookings(user_id):
    conn = get_db_connection()
    if conn:
        cursor = conn.cursor()
        try:
            cursor.execute("""
                SELECT b.booking_id, m.title, s.show_date, s.show_time, 
                       b.tickets_booked, b.booking_date, b.seat_numbers
                FROM Bookings b JOIN Showtimes s ON b.showtime_id = s.showtime_id
                JOIN Movies m ON s.movie_id = m.movie_id WHERE b.user_id = %s
                ORDER BY b.booking_date DESC
            """, (user_id,))
            return cursor.fetchall()
        finally:
            cursor.close()
            conn.close()
    return []

# FIXED: Callback function for Book Now buttons
def book_movie(movie_id):
    st.session_state.selected_movie = movie_id
    st.session_state.current_menu = "Book Tickets"
    st.rerun()

# Initialize session state
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
if 'user_id' not in st.session_state:
    st.session_state.user_id = None
if 'username' not in st.session_state:
    st.session_state.username = None
if 'is_admin' not in st.session_state:
    st.session_state.is_admin = False
if 'selected_seats' not in st.session_state:
    st.session_state.selected_seats = []
if 'selected_movie' not in st.session_state:
    st.session_state.selected_movie = None
if 'current_menu' not in st.session_state:
    st.session_state.current_menu = "Browse Movies"

def load_css():
    st.markdown("""
    <style>
    * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .stApp { background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); }
    [data-testid="stSidebar"] { background: #ffffff; border-right: 1px solid #e2e8f0; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
    h1 { color: #1e293b; font-weight: 800; font-size: 52px; letter-spacing: -2px; margin-bottom: 40px; }
    .stButton > button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; border-radius: 12px; padding: 16px 36px; font-weight: 700; box-shadow: 0 4px 15px rgba(102,126,234,0.3); }
    .stButton > button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(102,126,234,0.4); }
    #MainMenu, footer { visibility: hidden; }
    </style>
    """, unsafe_allow_html=True)

def main():
    st.set_page_config(page_title="CineBook - Movie Booking", page_icon="üé¨", layout="wide", initial_sidebar_state="expanded")
    load_css()

    st.sidebar.title("üé¨ CineBook")

    # Login/Signup (unchanged)
    if not st.session_state.logged_in:
        menu = st.sidebar.radio("Menu", ["Login", "Sign Up"])
        if menu == "Sign Up":
            st.title("Create Account")
            with st.form("signup_form"):
                username = st.text_input("Username")
                email = st.text_input("Email")
                password = st.text_input("Password", type="password")
                confirm_password = st.text_input("Confirm Password", type="password")
                if st.form_submit_button("Sign Up"):
                    if password != confirm_password:
                        st.error("Passwords don't match!")
                    elif len(password) < 6:
                        st.error("Password must be at least 6 characters!")
                    elif register_user(username, password, email):
                        st.success("Account created! Please login.")
        else:
            st.title("Welcome Back")
            with st.form("login_form"):
                username = st.text_input("Username")
                password = st.text_input("Password", type="password")
                if st.form_submit_button("Login"):
                    user = login_user(username, password)
                    if user:
                        st.session_state.logged_in = True
                        st.session_state.user_id = user['user_id']
                        st.session_state.username = user['username']
                        st.session_state.is_admin = user.get('is_admin', 0) == 1
                        st.rerun()
                    else:
                        st.error("Invalid credentials!")
        return

    # USER IS LOGGED IN
    st.sidebar.success(f"üëã {st.session_state.username}")

    # FIXED: Menu logic - PRIORITIZE session_state.current_menu over radio
    menu_options = ["Browse Movies", "Book Tickets", "My Bookings", "Logout"]
    if st.session_state.is_admin:
        menu_options.insert(3, "Admin Panel")

    # CRITICAL FIX: Use session_state directly for menu selection [web:21][web:25]
    current_menu = st.session_state.current_menu
    if current_menu not in menu_options:
        current_menu = "Browse Movies"
        st.session_state.current_menu = current_menu

    # Sidebar radio - NOW just for display, doesn't override session state
    menu_display = st.sidebar.radio("Menu", menu_options, key="sidebar_display", index=menu_options.index(current_menu))

    # Handle menu navigation
    if menu_display == "Logout":
        for key in list(st.session_state.keys()):
            del st.session_state[key]
        st.rerun()

    # MAIN MENU ROUTING - This now works perfectly! [web:25]
    if current_menu == "Browse Movies":
        st.title("Now Showing üé¨")
        movies = get_movies()
        
        if movies:
            col1, col2 = st.columns([1, 1])
            with col1:
                lang_filter = st.selectbox("Language", ["All", "Hindi", "English"], key="lang_filter")
            with col2:
                genres = ["All"] + list(set(m['genre'] for m in movies))
                genre_filter = st.selectbox("Genre", genres, key="genre_filter")

            filtered_movies = [m for m in movies 
                             if (lang_filter == "All" or m['language'] == lang_filter) and 
                                (genre_filter == "All" or m['genre'] == genre_filter)]

            cols = st.columns(3)
            for idx, movie in enumerate(filtered_movies):
                with cols[idx % 3]:
                    st.markdown(f"""
                    <div style='background: #ffffff; border-radius: 16px; padding: 20px; text-align: center;
                               border: 2px solid #e2e8f0; box-shadow: 0 8px 25px rgba(0,0,0,0.1);'>
                        <img src='{movie['poster_url']}' style='width: 100%; height: 300px; object-fit: cover; border-radius: 12px;'/>
                        <h3 style='color: #1e293b; margin: 16px 0 8px 0;'>{movie['title']}</h3>
                        <p style='color: #64748b;'>{movie['genre']} ‚Ä¢ {movie['duration']}min ‚Ä¢ ‚≠ê{movie['rating']}</p>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # FIXED: Callback ensures session state persists through re-run [web:21][web:25]
                    if st.button(f"üé´ Book {movie['title'][:15]}...", key=f"book_{movie['movie_id']}", 
                               on_click=book_movie, args=(movie['movie_id'],), use_container_width=True):
                        pass  # Callback handles everything

    elif current_menu == "Book Tickets":
        st.title("üéüÔ∏è Book Tickets")
        
        # Auto-select movie if coming from Browse Movies
        movies = get_movies()
        if st.session_state.selected_movie:
            selected_movie = next((m for m in movies if m['movie_id'] == st.session_state.selected_movie), None)
            movie_id = st.session_state.selected_movie
        else:
            movie_options = {f"{m['title']} ({m['language']})": m['movie_id'] for m in movies}
            selected_movie_key = st.selectbox("Select Movie", list(movie_options.keys()), key="movie_select")
            movie_id = movie_options[selected_movie_key]
            selected_movie = next(m for m in movies if m['movie_id'] == movie_id)

        if selected_movie:
            col1, col2 = st.columns([1, 2])
            with col1:
                st.image(selected_movie['poster_url'], use_container_width=True)
            with col2:
                st.subheader(selected_movie['title'])
                st.write(f"**{selected_movie['genre']} ‚Ä¢ {selected_movie['duration']}min ‚Ä¢ ‚≠ê{selected_movie['rating']}**")
                st.write(selected_movie['description'])

            showtimes = get_showtimes(movie_id)
            if showtimes:
                st.subheader("Select Showtime")
                showtime_options = {f"{s['show_date']} {s['show_time']} ({s['available_seats']} seats)": s['showtime_id'] for s in showtimes}
                selected_showtime = st.selectbox("Choose showtime", list(showtime_options.keys()), key="showtime_select")
                showtime_id = showtime_options[selected_showtime]

                # Seat selection (simplified but functional)
                st.subheader("Select Seats")
                booked_seats = get_booked_seats(showtime_id)
                st.session_state.selected_seats = [s for s in st.session_state.selected_seats if s not in booked_seats]

                cols = st.columns(10)
                for i, seat in enumerate([f"A{i+1}" for i in range(10)]):
                    with cols[i]:
                        if seat in booked_seats:
                            st.button("üî¥", key=f"booked_{seat}", disabled=True)
                        elif seat in st.session_state.selected_seats:
                            if st.button("üü°", key=f"selected_{seat}"):
                                st.session_state.selected_seats.remove(seat)
                                st.rerun()
                        else:
                            if st.button("üü¢", key=f"avail_{seat}"):
                                st.session_state.selected_seats.append(seat)
                                st.rerun()

                if st.session_state.selected_seats:
                    st.success(f"Selected: {', '.join(sorted(st.session_state.selected_seats))} ({len(st.session_state.selected_seats)} seats)")
                    col1, col2 = st.columns(2)
                    with col1:
                        if st.button("Clear", key="clear_seats"):
                            st.session_state.selected_seats = []
                            st.rerun()
                    with col2:
                        if st.button("Confirm Booking", key="confirm_booking"):
                            if book_tickets(st.session_state.user_id, showtime_id, st.session_state.selected_seats):
                                st.session_state.selected_seats = []
                                st.session_state.selected_movie = None
                                st.session_state.current_menu = "My Bookings"
                                st.success("üéâ Booking confirmed!")
                                st.balloons()
                                st.rerun()
            else:
                st.warning("No available showtimes")

    elif current_menu == "My Bookings":
        st.title("My Bookings")
        bookings = get_user_bookings(st.session_state.user_id)
        if bookings:
            for b in bookings:
                st.info(f"**{b['title']}** - {b['show_date']} {b['show_time']} | Seats: {b['seat_numbers']}")
        else:
            st.info("No bookings yet!")

    elif current_menu == "Admin Panel" and st.session_state.is_admin:
        st.title("Admin Dashboard")
        # Admin panel content here...

if __name__ == "__main__":
    main()
